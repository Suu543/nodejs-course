# TaskApp REST APIs and Mongoose
- Part12 참고

## Setting up Mongoose
- https://mongoosejs.com/

```javascript
// src/db/mongoose.js
const mongoose = require("mongoose");

mongoose.connect("mongodb://localhost:27017/task-manager-api", {
  useNewUrlParser: true,
});

// Define User Model
const User = mongoose.model("User", {
  name: {
    type: String,
  },

  age: {
    type: Number,
  },
});

const me = new User({
  name: "Yongsu",
  age: 24,
});

me.save()
  .then(() => {
    console.log(me);
  })
  .catch((error) => {
    console.log("Error ==> ", error);
  });
```

```javascript
// src/db/mongoose.js
// Error Testcase
const mongoose = require("mongoose");

mongoose.connect("mongodb://localhost:27017/task-manager-api", {
  useNewUrlParser: true,
});

// Define User Model
const User = mongoose.model("User", {
  name: {
    type: String,
  },

  age: {
    type: Number,
  },
});

const me = new User({
  name: "Yongsu",
  age: "Nike",
});

me.save()
  .then(() => {
    console.log(me);
  })
  .catch((error) => {
    console.log("Error ==> ", error);
  });
```

## Creating a Mongoose Model
1. `tasks` 모델 생성하기 
- fields: description and completed
2. `tasks` 모델 인스턴스 생성하기
3. 생성한 인스턴스 DB에 저장하기
```javascript
// src/db/mongoose.js
const Task = mongoose.model("Task", {
  description: {
    type: String,
  },

  completed: {
    type: Boolean,
  },
});

const task = new Task({
  description: "Learn the Mongoose",
  completed: false,
});

task
  .save()
  .then(() => {
    console.log(task);
  })
  .catch((error) => {
    console.log("error ==> ", error);
  });

```

## Data Validation and Sanitization Part1
- 특수문자가 포함되어 있거나, 또는 키:값 쌍이 맞지 않거나 등의 경우에 유효한 JSON으로 변경해 주는 걸 의미합니다.
- https://mongoosejs.com/docs/validation.html
```javascript
// name이 required이기 때문에 오류가 발생한다.
// src/db/mongoose.js
const User = mongoose.model("User", {
  name: {
    type: String,
    required: true,
  },

  age: {
    type: Number,
  },
});

const me = new User({});
```

```javascript
// src/db/mongoose.js
const User = mongoose.model("User", {
  name: {
    type: String,
    required: true,
  },

  age: {
    type: Number,
    validate(value) {
      if (value < 0) {
        throw new Error("Age must be a positive number");
      }
    },
  },
});

const me = new User({
  name: "Yongsu",
  age: -5,
});
```
- https://www.npmjs.com/package/validator
```javascript
// src/db/mongoose.js
const mongoose = require("mongoose");
const validator = require("validator");

mongoose.connect("mongodb://localhost:27017/task-manager-api", {
  useNewUrlParser: true,
});

// Define User Model
const User = mongoose.model("User", {
  name: {
    type: String,
    required: true,
    trim: true,
  },

  email: {
    type: String,
    required: true,
    trim: true,
    lowercase: true,
    validate(value) {
      if (!validator.isEmail(value)) {
        throw new Error("Email is invalid");
      }
    },
  },

  age: {
    type: Number,
    default: 0,
    validate(value) {
      if (value < 0) {
        throw new Error("Age must be a positive number");
      }
    },
  },
});

// Testcase
const me = new User({
  name: "   Yongsu    ",
  email: "jpojoppojpojpo@naver.io     ",
});

me.save()
  .then(() => {
    console.log(me);
  })
  .catch((error) => {
    console.log("Error ==> ", error);
  });

const Task = mongoose.model("Task", {
  description: {
    type: String,
  },

  completed: {
    type: Boolean,
  },
});

// const task = new Task({
//   description: "Learn the Mongoose",
//   completed: false,
// });

// task
//   .save()
//   .then(() => {
//     console.log(task);
//   })
//   .catch((error) => {
//     console.log("error ==> ", error);
//   });

```

## Data Validation and Sanitization Part2
1. `User` 모델 재정의하기 
- 1. `password` 필드를 `required`로 정의하기
- 2. `password` 길이가 6글자 이상이 되도록 만들기
- 3. `password` 앞뒤로 공백 제거하기
- 4. `password` 값에 `password`라는 단어가 포함되지 않게 만들기

2. `Task` 모델 재정의하기
- 1. `description` 앞뒤로 공백 제거하기
- 2. `completed` 필드 기본값 `false`로 설정
```javascript
const mongoose = require("mongoose");
const validator = require("validator");

mongoose.connect("mongodb://localhost:27017/task-manager-api", {
  useNewUrlParser: true,
});

// Define User Model
const User = mongoose.model("User", {
  name: {
    type: String,
    required: true,
    trim: true,
  },

  email: {
    type: String,
    required: true,
    trim: true,
    lowercase: true,
    validate(value) {
      if (!validator.isEmail(value)) {
        throw new Error("Email is invalid");
      }
    },
  },

  password: {
    type: String,
    required: true,
    minlength: 7,
    trim: true,
    validate(value) {
      if (value.includes("password")) {
        throw new Error('Password cannot contain "password"');
      }
    },
  },

  age: {
    type: Number,
    default: 0,
    validate(value) {
      if (value < 0) {
        throw new Error("Age must be a positive number");
      }
    },
  },
});

// Testcase
const me = new User({
  name: "Yongsu",
  email: "abcdefg522@gmail.com",
  password: "phone093",
});

me.save()
  .then(() => {
    console.log(me);
  })
  .catch((error) => {
    console.log("Error ==> ", error);
  });

const Task = mongoose.model("Task", {
  description: {
    type: String,
    required: true,
    trim: true,
  },

  completed: {
    type: Boolean,
    default: false,
  },
});

const task = new Task({
  description: "Learn the Mongoose",
  completed: false,
});

task
  .save()
  .then(() => {
    console.log(task);
  })
  .catch((error) => {
    console.log("error ==> ", error);
  });
```
## Structuring a REST API
<img src="https://cdn-images-1.medium.com/max/1000/1*hZRe3IoWokuuOSziboioBw.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*RCJ6x6vGpnNSs6tH5TG9jw.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*G0TyDnIAv3aSuJTRchrmfw.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*D5DUeauUIHz6E_K8te03bQ.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*OPNphodS1oSANRhdKzRlSw.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*v-iiFLXodNxtTwNTmZGgfA.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*4kUj1V1UucnGrfsqVDAxPQ.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*9qfi1_XU2mwBZfnTtUHQsQ.png" />
<img src="https://cdn-images-1.medium.com/max/1000/1*hKY-dGjFEWdu9sYUS1pWRA.png" />

## Resource Creation Endpoints: Part1
```javascript
// src/index.js
const express = require("express");

const PORT = process.env.PORT || 3000;
const app = express();

app.post("/users", (req, res, next) => {
  console.log(req.body);
  res.send("Testing!");
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```
```json
{
    "name": "Hello World",
    "email": "hello5555@gmail.com",
    "password": "hello123$"
}
```

- Refactoring
```javascript
// src/models/user.js
const mongoose = require("mongoose");
const validator = require("validator");

const User = mongoose.model("User", {
  name: {
    type: String,
    required: true,
    trim: true,
  },

  email: {
    type: String,
    required: true,
    trim: true,
    lowercase: true,
    validate(value) {
      if (!validator.isEmail(value)) {
        throw new Error("Email is invalid");
      }
    },
  },

  password: {
    type: String,
    required: true,
    minlength: 7,
    trim: true,
    validate(value) {
      if (value.includes("password")) {
        throw new Error('Password cannot contain "password"');
      }
    },
  },

  age: {
    type: Number,
    default: 0,
    validate(value) {
      if (value < 0) {
        throw new Error("Age must be a positive number");
      }
    },
  },
});

module.exports = User;
```
- https://httpstatus.io/http-status-codes
```javascript
// src/index.js
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");

const PORT = process.env.PORT || 3000;
const app = express();

app.post("/users", (req, res, next) => {
  const user = new User(req.body);

  user
    .save()
    .then(() => {
      res.send(user);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```

## Resource Creation Endpoints: Part2
1. `Task` 모델을 담당하는 별도의 파일을 생성
2. `Task` 생성에 해당하는 `endpoint` 생성하기 (성공, 실패 케이스 모두 정의)

```javascript
// src/models/task.js
const mongoose = require("mongoose");
const validator = require("validator");

const Task = mongoose.model("Task", {
  description: {
    type: String,
    required: true,
    trim: true,
  },

  completed: {
    type: Boolean,
    default: false,
  },
});

module.exports = Task;
```

```javascript
// src/index.js
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

app.post("/users", (req, res, next) => {
  const user = new User(req.body);

  user
    .save()
    .then(() => {
      res.status(201).send(user);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

app.post("/tasks", (req, res, next) => {
  const task = new Task(req.body);

  task
    .save()
    .then(() => {
      res.status(201).send(task);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```

## Resource Reading Endpoints: Part1
- https://mongoosejs.com/docs/queries.html
```javascript
// src/index.js
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", (req, res, next) => {
  User.find({})
    .then((users) => {
      res.send(users);
    })
    .catch((err) => {
      res.status(500).send(err);
    });
});

app.get("/users/:id", (req, res, next) => {
  const _id = req.params.id;

  User.findById(_id)
    .then((user) => {
      if (!user) {
        return res.status(404).send();
      }

      res.send(user);
    })
    .catch((err) => {
      res.status(500).send();
    });
});

app.post("/users", (req, res, next) => {
  const user = new User(req.body);

  user
    .save()
    .then(() => {
      res.status(201).send(user);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

// Tasks
app.post("/tasks", (req, res, next) => {
  const task = new Task(req.body);

  task
    .save()
    .then(() => {
      res.status(201).send(task);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```


## Resource Reading Endpoints: Part2
1. 모든 `Task`를 가져오는(fetching) `endpoint` 생성하기
2. `id`값을 이용해 특정 `Task`를 가져오는(fetching) `endpoint` 생성하기

```javascript
// src/index.js
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", (req, res, next) => {
  User.find({})
    .then((users) => {
      res.send(users);
    })
    .catch((err) => {
      res.status(500).send(err);
    });
});

app.get("/users/:id", (req, res, next) => {
  const _id = req.params.id;

  User.findById(_id)
    .then((user) => {
      if (!user) {
        return res.status(404).send();
      }

      res.send(user);
    })
    .catch((err) => {
      res.status(500).send();
    });
});

app.post("/users", (req, res, next) => {
  const user = new User(req.body);

  user
    .save()
    .then(() => {
      res.status(201).send(user);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

// Tasks
app.get("/tasks", (req, res, next) => {
  Task.find({})
    .then((tasks) => {
      res.send(tasks);
    })
    .catch((err) => {
      res.status(500).send(err);
    });
});

app.get("/tasks/:id", (req, res, next) => {
  const _id = req.params.id;

  Task.findById(_id)
    .then((task) => {
      if (!task) {
        return res.status(404).send();
      }

      res.send(task);
    })
    .catch((err) => {
      res.status(500).send();
    });
});

app.post("/tasks", (req, res, next) => {
  const task = new Task(req.body);

  task
    .save()
    .then(() => {
      res.status(201).send(task);
    })
    .catch((err) => {
      res.status(400).send(err);
    });
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```

## Promise Chaining
- Case1
```javascript
const add = (a, b) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(a + b);
    }, 2000);
  });
};

add(1, 2)
  .then((sum) => {
    console.log(sum);

    add(sum, 5)
      .then((sum2) => {
        console.log(sum2);
      })
      .catch((err) => {
        console.log(err);
      });
  })
  .catch((err) => {
    console.log(err);
  });
```
- Case2
```javascript
const add = (a, b) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve(a + b);
    }, 2000);
  });
};

add(1, 1)
  .then((sum) => {
    console.log(sum);
    return add(sum, 4);
  })
  .then((sum2) => {
    console.log(sum2);
  })
  .catch((err) => {
    console.log(err);
  });

```
```javascript
// playground/promise-chaining.js
require("../src/db/mongoose");
const User = require("../src/models/user");

User.findByIdAndUpdate("625d674132bf26ce7582f711", { age: 1 })
  .then((user) => {
    console.log(user);
    return User.countDocuments({ age: 1 });
  })
  .then((result) => {
    console.log(result);
  })
  .catch((err) => {
    console.log(err);
  });
```

- Challenge
1. `promise-chaining-2.js` 파일 생성
2. `task` 모든 가져오기
3. `id`를 이용해 특정 `task` 삭제하기
4. `task` 상태가 `incomplete`인 것의 개수를 출력하기

```javascript
require("../src/db/mongoose");
const Task = require("../src/models/task");

Task.findByIdAndDelete("625d674132bf26ce7582f711")
  .then((task) => {
    console.log(task);
    return Task.countDocuments({ completed: false });
  })
  .then((result) => {
    console.log(result);
  })
  .catch(err);
```

## Async/Await

```javascript
const add = (a, b) => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (a < 0 || b < 0) {
        return reject("Numbers must be non-negative");
      }

      resolve(a + b);
    }, 2000);
  });
};

const doWork = async () => {
  const sum = await add(1, 99);
  const sum2 = await add(sum, 50);
  const sum3 = await add(sum2, 100);
  return sum3;
};

doWork()
  .then((result) => {
    console.log("result", result);
  })
  .catch((err) => {
    console.log("error =>", err);
  });
```

```javascript
// playground/promise-chaining.js
require("../src/db/mongoose");
const User = require("../src/models/user");

// User.findByIdAndUpdate("625d674132bf26ce7582f711", { age: 1 })
//   .then((user) => {
//     console.log(user);
//     return User.countDocuments({ age: 1 });
//   })
//   .then((result) => {
//     console.log(result);
//   })
//   .catch((err) => {
//     console.log(err);
//   });

const updateAgeAndCount = async (id, age) => {
  const user = await User.findByIdAndUpdate(id, { age });
  const count = await User.countDocuments({ age });
  return count;
};

updateAgeAndCount("625d674132bf26ce7582f711", { age: 1 })
  .then((count) => {
    console.log(count);
  })
  .catch((err) => {
    console.log(err);
  });
```

```javascript
// playground/promise-chaining2.js
require("../src/db/mongoose");
const Task = require("../src/models/task");

// Task.findByIdAndDelete("625d674132bf26ce7582f711")
//   .then((task) => {
//     console.log(task);
//     return Task.countDocuments({ completed: false });
//   })
//   .then((result) => {
//     console.log(result);
//   })
//   .catch(err);

const deleteTaskAndCount = async (id) => {
  const task = await Task.findByIdAndDelete(id);
  const count = await Task.countDocuments({ completed: false });
  return count;
};

deleteTaskAndCount("625d674132bf26ce7582f711")
  .then((count) => {
    console.log(count);
  })
  .catch((err) => {
    console.log(err);
  });
```
## Integrating Async/Await
- User Refactor
```javascript
// src/index.js
// Users
app.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }

  // User.find({})
  //   .then((users) => {
  //     res.send(users);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }

  // User.findById(_id)
  //   .then((user) => {
  //     if (!user) {
  //       return res.status(404).send();
  //     }

  //     res.send(user);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }

  // user
  //   .save()
  //   .then(() => {
  //     res.status(201).send(user);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});
```

- Challenge - Task Refactor
```javascript
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }

  // User.find({})
  //   .then((users) => {
  //     res.send(users);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }

  // User.findById(_id)
  //   .then((user) => {
  //     if (!user) {
  //       return res.status(404).send();
  //     }

  //     res.send(user);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }

  // user
  //   .save()
  //   .then(() => {
  //     res.status(201).send(user);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

// Tasks
app.get("/tasks", async (req, res, next) => {
  try {
    const tasks = await Task.find({});
    res.send(tasks);
  } catch (err) {
    res.status(500).send();
  }

  // Task.find({})
  //   .then((tasks) => {
  //     res.send(tasks);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/tasks/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const task = await Task.findById(_id);

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }

  // Task.findById(_id)
  //   .then((task) => {
  //     if (!task) {
  //       return res.status(404).send();
  //     }

  //     res.send(task);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/tasks", async (req, res, next) => {
  const task = new Task(req.body);

  try {
    await task.save();
    res.status(201).send(task);
  } catch (err) {
    res.status(400).send(err);
  }

  // task
  //   .save()
  //   .then(() => {
  //     res.status(201).send(task);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```

## Resource Updating Endpoints: Part1
```javascript
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }

  // User.find({})
  //   .then((users) => {
  //     res.send(users);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }

  // User.findById(_id)
  //   .then((user) => {
  //     if (!user) {
  //       return res.status(404).send();
  //     }

  //     res.send(user);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }

  // user
  //   .save()
  //   .then(() => {
  //     res.status(201).send(user);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/users/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["name", "email", "password", "age"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const user = await User.findOneAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(400).send(err);
  }
});

// Tasks
app.get("/tasks", async (req, res, next) => {
  try {
    const tasks = await Task.find({});
    res.send(tasks);
  } catch (err) {
    res.status(500).send();
  }

  // Task.find({})
  //   .then((tasks) => {
  //     res.send(tasks);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/tasks/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const task = await Task.findById(_id);

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }

  // Task.findById(_id)
  //   .then((task) => {
  //     if (!task) {
  //       return res.status(404).send();
  //     }

  //     res.send(task);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/tasks", async (req, res, next) => {
  const task = new Task(req.body);

  try {
    await task.save();
    res.status(201).send(task);
  } catch (err) {
    res.status(400).send(err);
  }

  // task
  //   .save()
  //   .then(() => {
  //     res.status(201).send(task);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```
## Resource Updating Endpoints: Part2
1. `Task`를 업데이트하는 라우터 생성하기
2. `Task` 업데이트 세 가지 로직 구현하기
- Not Found
- Validation Errors
- Success
```javascript
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }

  // User.find({})
  //   .then((users) => {
  //     res.send(users);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }

  // User.findById(_id)
  //   .then((user) => {
  //     if (!user) {
  //       return res.status(404).send();
  //     }

  //     res.send(user);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }

  // user
  //   .save()
  //   .then(() => {
  //     res.status(201).send(user);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/users/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["name", "email", "password", "age"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const user = await User.findOneAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(400).send(err);
  }
});

// Tasks
app.get("/tasks", async (req, res, next) => {
  try {
    const tasks = await Task.find({});
    res.send(tasks);
  } catch (err) {
    res.status(500).send();
  }

  // Task.find({})
  //   .then((tasks) => {
  //     res.send(tasks);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/tasks/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const task = await Task.findById(_id);

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }

  // Task.findById(_id)
  //   .then((task) => {
  //     if (!task) {
  //       return res.status(404).send();
  //     }

  //     res.send(task);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/tasks", async (req, res, next) => {
  const task = new Task(req.body);

  try {
    await task.save();
    res.status(201).send(task);
  } catch (err) {
    res.status(400).send(err);
  }

  // task
  //   .save()
  //   .then(() => {
  //     res.status(201).send(task);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/tasks/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["description", "completed"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const task = await Task.findByIdAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(400).send(err);
  }
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```

## Resource Deleting Endpoints
```javascript
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }

  // User.find({})
  //   .then((users) => {
  //     res.send(users);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }

  // User.findById(_id)
  //   .then((user) => {
  //     if (!user) {
  //       return res.status(404).send();
  //     }

  //     res.send(user);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }

  // user
  //   .save()
  //   .then(() => {
  //     res.status(201).send(user);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/users/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["name", "email", "password", "age"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const user = await User.findOneAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(400).send(err);
  }
});

app.delete("/users/:id", async (req, res, next) => {
  try {
    const user = await User.findOneAndDelete(req.params.id);

    if (!user) {
      return res.status(404).send();
    }
  } catch (err) {
    res.status(500).send();
  }
});

// Tasks
app.get("/tasks", async (req, res, next) => {
  try {
    const tasks = await Task.find({});
    res.send(tasks);
  } catch (err) {
    res.status(500).send();
  }

  // Task.find({})
  //   .then((tasks) => {
  //     res.send(tasks);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/tasks/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const task = await Task.findById(_id);

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }

  // Task.findById(_id)
  //   .then((task) => {
  //     if (!task) {
  //       return res.status(404).send();
  //     }

  //     res.send(task);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/tasks", async (req, res, next) => {
  const task = new Task(req.body);

  try {
    await task.save();
    res.status(201).send(task);
  } catch (err) {
    res.status(400).send(err);
  }

  // task
  //   .save()
  //   .then(() => {
  //     res.status(201).send(task);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/tasks/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["description", "completed"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const task = await Task.findByIdAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(400).send(err);
  }
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```

1. `task` 삭제 `endpoint` 생성하기
2. `Task` 업데이트 세 가지 로직 구현하기
- Not Found
- Validation Errors
- Success
```javascript
const express = require("express");
require("./db/mongoose");

// Models
const User = require("./models/user");
const Task = require("./models/task");

const PORT = process.env.PORT || 3000;
const app = express();

// Users
app.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }

  // User.find({})
  //   .then((users) => {
  //     res.send(users);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }

  // User.findById(_id)
  //   .then((user) => {
  //     if (!user) {
  //       return res.status(404).send();
  //     }

  //     res.send(user);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }

  // user
  //   .save()
  //   .then(() => {
  //     res.status(201).send(user);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/users/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["name", "email", "password", "age"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const user = await User.findOneAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(400).send(err);
  }
});

app.delete("/users/:id", async (req, res, next) => {
  try {
    const user = await User.findOneAndDelete(req.params.id);

    if (!user) {
      return res.status(404).send();
    }
  } catch (err) {
    res.status(500).send();
  }
});

// Tasks
app.get("/tasks", async (req, res, next) => {
  try {
    const tasks = await Task.find({});
    res.send(tasks);
  } catch (err) {
    res.status(500).send();
  }

  // Task.find({})
  //   .then((tasks) => {
  //     res.send(tasks);
  //   })
  //   .catch((err) => {
  //     res.status(500).send(err);
  //   });
});

app.get("/tasks/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const task = await Task.findById(_id);

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }

  // Task.findById(_id)
  //   .then((task) => {
  //     if (!task) {
  //       return res.status(404).send();
  //     }

  //     res.send(task);
  //   })
  //   .catch((err) => {
  //     res.status(500).send();
  //   });
});

app.post("/tasks", async (req, res, next) => {
  const task = new Task(req.body);

  try {
    await task.save();
    res.status(201).send(task);
  } catch (err) {
    res.status(400).send(err);
  }

  // task
  //   .save()
  //   .then(() => {
  //     res.status(201).send(task);
  //   })
  //   .catch((err) => {
  //     res.status(400).send(err);
  //   });
});

app.patch("/tasks/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["description", "completed"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const task = await Task.findByIdAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(400).send(err);
  }
});

app.delete("/tasks/:id", async (req, res, next) => {
  try {
    const task = await Task.findByIdAndDelete(req.params.id);

    if (!task) {
      res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }
});

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```
## Separate Route Files
```javascript
// src/routes/user.js
const express = require("express");
const router = new express.Router();

const User = require("../models/user");

// Users
router.get("/users", async (req, res, next) => {
  try {
    const users = await User.find({});
    res.send(users);
  } catch (err) {
    res.status(500).send();
  }
});

router.get("/users/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const user = await User.findById(_id);

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(500).send();
  }
});

router.post("/users", async (req, res, next) => {
  const user = new User(req.body);

  try {
    await user.save();
    res.status(201).send(user);
  } catch (err) {
    res.status(400).send(err);
  }
});

router.patch("/users/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["name", "email", "password", "age"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const user = await User.findOneAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!user) {
      return res.status(404).send();
    }

    res.send(user);
  } catch (err) {
    res.status(400).send(err);
  }
});

router.delete("/users/:id", async (req, res, next) => {
  try {
    const user = await User.findOneAndDelete(req.params.id);

    if (!user) {
      return res.status(404).send();
    }
  } catch (err) {
    res.status(500).send();
  }
});

module.exports = router;
```

```javascript
// src/routes/task.js
const express = require("express");
const router = new express.Router();

const Task = require("../models/task");

// Tasks
router.get("/tasks", async (req, res, next) => {
  try {
    const tasks = await Task.find({});
    res.send(tasks);
  } catch (err) {
    res.status(500).send();
  }
});

router.get("/tasks/:id", async (req, res, next) => {
  const _id = req.params.id;

  try {
    const task = await Task.findById(_id);

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }
});

router.post("/tasks", async (req, res, next) => {
  const task = new Task(req.body);

  try {
    await task.save();
    res.status(201).send(task);
  } catch (err) {
    res.status(400).send(err);
  }
});

router.patch("/tasks/:id", async (req, res, next) => {
  const updates = Object.keys(req.body);
  const allowedUpdates = ["description", "completed"];
  const isValidOperation = updates.every((update) =>
    allowedUpdates.includes(update)
  );

  if (!isValidOperation) {
    return res.status(400).send({ error: "Invalid Updates!" });
  }

  try {
    const task = await Task.findByIdAndUpdate(req.params.id, req.body, {
      new: true,
      runValidators: true,
    });

    if (!task) {
      return res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(400).send(err);
  }
});

router.delete("/tasks/:id", async (req, res, next) => {
  try {
    const task = await Task.findByIdAndDelete(req.params.id);

    if (!task) {
      res.status(404).send();
    }

    res.send(task);
  } catch (err) {
    res.status(500).send();
  }
});

module.exports = router;
```

```javascript
// src/index.js
const express = require("express");
require("./db/mongoose");
const userRouter = require("./routes/user");
const taskRouter = require("./routes/task");

const PORT = process.env.PORT || 3000;
const app = express();

app.use(express.json());
app.use(
  express.urlencoded({
    extended: false,
  })
);

app.use(userRouter);
app.use(taskRouter);

app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
});
```